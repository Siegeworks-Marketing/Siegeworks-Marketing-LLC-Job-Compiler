<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Siegeworks Job Compiler</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f172a;
  color: #f1f5f9;
  margin: 0;
}

header {
  padding: 40px 20px;
  text-align: center;
}

h1 { margin: 0; font-size: 32px; }
.sub { color: #94a3b8; margin-top: 8px; }

.search-container {
  max-width: 900px;
  margin: 20px auto;
  padding: 20px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

input, textarea {
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
}

input { width: 220px; }
textarea { width: 100%; max-width: 850px; height: 100px; }

button {
  padding: 12px 18px;
  border-radius: 8px;
  border: none;
  background: #2563eb;
  color: white;
  font-weight: 600;
  cursor: pointer;
}

button:hover { background: #1d4ed8; }

.toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
}

.results {
  max-width: 900px;
  margin: 40px auto;
  padding: 0 20px;
}

.job-card {
  background: #1e293b;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 16px;
}

.job-title { font-size: 18px; font-weight: 600; }
.job-meta { font-size: 13px; color: #94a3b8; margin: 6px 0; }
.job-score { font-size: 13px; color: #60a5fa; }
.job-snippet { font-size: 14px; margin-top: 10px; }

.apply-link {
  display: inline-block;
  margin-top: 12px;
  text-decoration: none;
  color: #60a5fa;
  font-weight: 500;
}
</style>
</head>

<body>

<header>
  <h1>Siegeworks Marketing</h1>
  <div class="sub">AI-Assisted Multi-Source Job Compiler</div>
</header>

<div class="search-container">
  <input id="role" placeholder="Job title" />
  <input id="location" placeholder="Location or Remote" />
  <div class="toggle">
    <input type="checkbox" id="recentOnly" />
    <label for="recentOnly">Last 7 days only</label>
  </div>
  <button onclick="search()">Search</button>
  <textarea id="resumeText" placeholder="Paste resume text for ranking (optional)"></textarea>
</div>

<div class="results" id="results"></div>

<script>

/* ---------- Utilities ---------- */

function stripHTML(str) {
  const div = document.createElement("div");
  div.innerHTML = str;
  return div.textContent || "";
}

function daysOld(dateStr) {
  if (!dateStr) return 0;
  return (Date.now() - new Date(dateStr)) / 86400000;
}

function tokenize(text) {
  return text
    .toLowerCase()
    .replace(/[^\w\s]/g, "")
    .split(/\s+/)
    .filter(w => w.length > 3);
}

/* ---------- Resume Ranking ---------- */

function scoreJob(job, resumeText) {
  if (!resumeText) return 0;

  const resumeWords = tokenize(resumeText);
  const jobText = (job.title + " " + job.snippet).toLowerCase();

  let score = 0;
  resumeWords.forEach(word => {
    if (jobText.includes(word)) score++;
  });

  return score;
}

/* ---------- Sources ---------- */

async function fetchJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error();
  return r.json();
}

async function fetchRemotive(role) {
  const data = await fetchJSON(
    `https://remotive.com/api/remote-jobs?search=${encodeURIComponent(role)}`
  );

  return (data.jobs || []).map(j => ({
    id: "re_" + j.id,
    source: "Remotive",
    title: j.title,
    company: j.company_name,
    location: "Remote",
    url: j.url,
    snippet: stripHTML(j.description).slice(0, 280),
    date: j.publication_date
  }));
}

async function fetchJobicy(role) {
  const data = await fetchJSON(
    `https://jobicy.com/api/v2/remote-jobs?search=${encodeURIComponent(role)}`
  );

  return (data.jobs || []).map(j => ({
    id: "jc_" + j.id,
    source: "Jobicy",
    title: j.jobTitle,
    company: j.companyName,
    location: "Remote",
    url: j.url,
    snippet: j.jobExcerpt || "",
    date: j.pubDate
  }));
}

async function fetchMuse(role) {
  const data = await fetchJSON(
    `https://www.themuse.com/api/public/jobs?page=1`
  );

  return (data.results || [])
    .filter(j => j.name.toLowerCase().includes(role.toLowerCase()))
    .map(j => ({
      id: "mu_" + j.id,
      source: "The Muse",
      title: j.name,
      company: j.company?.name || "",
      location: (j.locations || []).map(l => l.name).join(", "),
      url: j.refs?.landing_page,
      snippet: stripHTML(j.contents).slice(0, 280),
      date: j.publication_date
    }));
}

/* ---------- Filtering ---------- */

function applyFilters(jobs, location, recentOnly) {
  return jobs.filter(job => {

    if (recentOnly && daysOld(job.date) > 7) return false;

    if (location && location.toLowerCase() !== "remote") {
      if (!job.location.toLowerCase().includes(location.toLowerCase()))
        return false;
    }

    return true;
  });
}

function dedupe(jobs) {
  const seen = new Set();
  return jobs.filter(j => {
    const key = (j.title + j.company + j.location).toLowerCase();
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

/* ---------- Rendering ---------- */

function render(jobs) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  if (!jobs.length) {
    container.innerHTML = "<p>No results found.</p>";
    return;
  }

  jobs.forEach(job => {
    const card = document.createElement("div");
    card.className = "job-card";

    card.innerHTML = `
      <div class="job-title">${job.title}</div>
      <div class="job-meta">
        ${job.company} | ${job.location} | ${job.source}
      </div>
      <div class="job-score">Match Score: ${job.score}</div>
      <div class="job-snippet">${job.snippet}</div>
      <a class="apply-link" href="${job.url}" target="_blank">
        Apply â†’
      </a>
    `;

    container.appendChild(card);
  });
}

/* ---------- Main ---------- */

async function search() {
  const role = document.getElementById("role").value.trim();
  const location = document.getElementById("location").value.trim();
  const recentOnly = document.getElementById("recentOnly").checked;
  const resumeText = document.getElementById("resumeText").value;

  if (!role) return;

  const container = document.getElementById("results");
  container.innerHTML = "<p>Searching live listings...</p>";

  const results = await Promise.allSettled([
    fetchRemotive(role),
    fetchJobicy(role),
    fetchMuse(role)
  ]);

  let jobs = results
    .filter(r => r.status === "fulfilled")
    .flatMap(r => r.value);

  jobs = dedupe(jobs);
  jobs = applyFilters(jobs, location, recentOnly);

  jobs.forEach(j => {
    j.score = scoreJob(j, resumeText);
  });

  jobs.sort((a, b) =>
    resumeText ? b.score - a.score : new Date(b.date) - new Date(a.date)
  );

  render(jobs);
}

</script>

</body>
</html>
